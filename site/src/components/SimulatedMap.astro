---
import simulatedRoutes from '../data/simulatedRoutes.json';

const MAP_ID = 'simulated-map';
// 5 rotas: Marabá–São Paulo (5) + nova (6) + outras 3
const all = Array.isArray(simulatedRoutes) ? simulatedRoutes : [];
const marabaSaoPaulo = all[5];
const novaRota = all[6];
const others = all.filter((_, i) => i !== 5 && i !== 6).slice(0, 3);
const base = [marabaSaoPaulo, novaRota, ...others].filter(Boolean);
const routes = base.length ? base.slice(0, 5) : all.slice(0, 5);
---

<div class="relative overflow-hidden bg-[#0f172a] rounded-b-lg simulated-map-container">
  <div id={MAP_ID} class="h-[280px] w-full sm:h-[320px]" aria-hidden="true"></div>
  <span class="absolute bottom-2 left-2 rounded px-2 py-1 text-[10px] font-medium uppercase tracking-wider text-white/70 bg-black/40 backdrop-blur-sm">Simulação — dados fictícios</span>
</div>

<script type="application/json" id="simulated-routes" set:html={JSON.stringify(routes)}></script>

<script is:inline>
(function () {
  function init() {
    if (typeof L === 'undefined') { setTimeout(init, 50); return; }
    var el = document.getElementById('simulated-map');
    if (!el) return;

    var routesEl = document.getElementById('simulated-routes');
    var routes = routesEl ? JSON.parse(routesEl.textContent || '[]') : [];
    if (!routes.length) return;

    setTimeout(function () {
      if (!document.getElementById('simulated-map')) return;
      var map = L.map('simulated-map', {
        center: [-15, -48],
        zoom: 4,
        zoomControl: false,
        attributionControl: false
      });

      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

      var colors = ['#3b82f6', '#22c55e', '#f59e0b', '#a855f7', '#ec4899'];
      var allPoints = [];
      var markers = [];
      var idxs = [];
      var tickMs = 300;

      for (var r = 0; r < routes.length; r++) {
        var route = routes[r];
        if (!route || route.length === 0) continue;
        for (var p = 0; p < route.length; p++) allPoints.push(route[p]);
        L.polyline(route, { color: colors[r % colors.length], weight: 3, opacity: 0.7 }).addTo(map);
        var carIcon = L.divIcon({
          className: 'simulated-marker',
          html: '<span style="display:block;width:16px;height:16px;background:' + colors[r % colors.length] + ';border:2px solid #fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.4)"></span>',
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        });
        var m = L.marker(route[0], { icon: carIcon }).addTo(map);
        markers.push(m);
        idxs.push(0);
      }

      try {
        var bounds = L.latLngBounds(allPoints);
        map.fitBounds(bounds, { padding: [32, 32], maxZoom: 12 });
      } catch (_) {
        map.setView([-15, -48], 4);
      }

      setInterval(function () {
        for (var i = 0; i < markers.length; i++) {
          var route = routes[i];
          if (!route || route.length === 0) continue;
          idxs[i] = (idxs[i] + 1) % route.length;
          markers[i].setLatLng(route[idxs[i]]);
        }
      }, tickMs);
    }, 0);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

<style>
  .simulated-marker { background: transparent !important; border: none !important; }
  .simulated-map-container .leaflet-control-zoom { border: none !important; }
  .simulated-map-container .leaflet-control-zoom a {
    background: rgba(17, 17, 17, 0.9) !important;
    color: #e5e5e5 !important;
    width: 32px !important;
    height: 32px !important;
    line-height: 32px !important;
    font-size: 18px !important;
  }
  .simulated-map-container .leaflet-control-zoom a:hover { background: rgba(39, 39, 42, 0.95) !important; }
</style>
