---
import streetRoute from '../data/streetRoute.json';

const MAP_ID = 'simulated-map';
---

<div class="relative overflow-hidden bg-[#0f172a] rounded-b-lg simulated-map-container">
  <div id={MAP_ID} class="h-[280px] w-full sm:h-[320px]" aria-hidden="true"></div>
  <span class="absolute bottom-2 left-2 rounded px-2 py-1 text-[10px] font-medium uppercase tracking-wider text-white/70 bg-black/40 backdrop-blur-sm">Simulação — dados fictícios</span>
</div>

<script type="application/json" id="street-route" set:html={JSON.stringify(streetRoute)}></script>

<script is:inline>
(function () {
  function init() {
    if (typeof L === 'undefined') { setTimeout(init, 50); return; }
    var el = document.getElementById('simulated-map');
    if (!el) return;

    var routeEl = document.getElementById('street-route');
    var route = routeEl ? JSON.parse(routeEl.textContent || '[]') : [];
    if (!route.length) return;

    setTimeout(function () {
      if (!document.getElementById('simulated-map')) return;
      var map = L.map('simulated-map', {
        center: [-23.5485, -46.638],
        zoom: 14,
        zoomControl: false,
        attributionControl: false
      });

      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

      try {
        var bounds = L.latLngBounds(route);
        map.fitBounds(bounds, { padding: [24, 24], maxZoom: 15 });
      } catch (_) {
        map.setView([-23.5485, -46.638], 14);
      }

      L.polyline(route, { color: '#3b82f6', weight: 4, opacity: 0.8 }).addTo(map);

      var n = route.length;
      var stopIndices = [
        Math.floor(n * 0.18),
        Math.floor(n * 0.38),
        Math.floor(n * 0.58),
        Math.floor(n * 0.78)
      ];
      var stopSet = {};
      for (var s = 0; s < stopIndices.length; s++) stopSet[stopIndices[s]] = true;

      var pIcon = L.divIcon({
        className: 'simulated-p-marker',
        html: '<span class="simulated-p-badge">P</span>',
        iconSize: [22, 22],
        iconAnchor: [11, 11]
      });
      for (var i = 0; i < stopIndices.length; i++) {
        L.marker(route[stopIndices[i]], { icon: pIcon }).addTo(map);
      }

      var carIcon = L.divIcon({
        className: 'simulated-marker',
        html: '<span style="display:block;width:20px;height:20px;background:#3b82f6;border:3px solid #fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.4)"></span>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      var carIconParado = L.divIcon({
        className: 'simulated-marker',
        html: '<span style="display:flex;flex-direction:column;align-items:center;width:40px"><span style="display:block;width:20px;height:20px;background:#3b82f6;border:3px solid #fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.4)"></span><span style="font-size:9px;font-weight:700;color:#fff;background:#22c55e;padding:2px 4px;border-radius:3px;margin-top:2px;white-space:nowrap">Parado</span></span>',
        iconSize: [40, 38],
        iconAnchor: [20, 10]
      });

      var marker = L.marker(route[0], { icon: carIcon }).addTo(map);
      var idx = 0;
      var paused = false;
      var pauseTicksLeft = 0;
      var tickMs = 280;
      var pauseTicks = 8;

      setInterval(function () {
        if (paused) {
          pauseTicksLeft--;
          if (pauseTicksLeft <= 0) {
            paused = false;
            marker.setIcon(carIcon);
          }
          return;
        }
        idx = (idx + 1) % route.length;
        marker.setLatLng(route[idx]);
        if (stopSet[idx]) {
          paused = true;
          pauseTicksLeft = pauseTicks;
          marker.setIcon(carIconParado);
        }
      }, tickMs);
    }, 0);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

<style>
  .simulated-marker { background: transparent !important; border: none !important; }
  .simulated-p-marker { background: transparent !important; border: none !important; }
  .simulated-p-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    font-size: 11px;
    font-weight: 700;
    color: #fff;
    background: #22c55e;
    border: 2px solid #fff;
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  }
  .simulated-map-container .leaflet-control-zoom { border: none !important; }
  .simulated-map-container .leaflet-control-zoom a {
    background: rgba(17, 17, 17, 0.9) !important;
    color: #e5e5e5 !important;
    width: 32px !important;
    height: 32px !important;
    line-height: 32px !important;
    font-size: 18px !important;
  }
  .simulated-map-container .leaflet-control-zoom a:hover { background: rgba(39, 39, 42, 0.95) !important; }
</style>
